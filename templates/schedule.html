<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>사랑의 홈쇼핑</title>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.5.2/css/bootstrap.min.css">
   <style>
       body {
           font-family: 'Arial', sans-serif;
           background-color: #f8f6f6;
           color: #16003B;
           margin: 0;
           padding: 0;
       }

       .logo {
           position: absolute;
           top: 50px;
           left: 50px;
           z-index: 1001;
       }

       .logo img {
           width: 100px;
           height: auto;
       }

       .logo2 {
           position: absolute;
           top: 50px;
           left: 700px;
           z-index: 1001;
       }

       .logo2 img {
           width: 500px;
           height: auto;
       }

       .header {
           background-color: transparent;
           padding: 15px 0;
           position: absolute;
           width: 100%;
           top: 150px;
           z-index: 1000;
           border-top: 1px solid #F72798;
           border-bottom: 1px solid #F72798;
       }

       .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;         
        justify-content: space-between; 
        position: relative;
    }

       .menu-bar {
           display: flex;
           justify-content: flex-start;
           flex-grow: 1;
           margin-left: -100px;
       }

       .menu-bar a {
           color: #F72798;
           text-decoration: none;
           margin: 0 30px;
           font-size: 18px;
           padding: 5px 0;
           transition: all 0.3s ease;
       }

       .menu-bar a:hover {
           color: #16003B;
           border-bottom: 2px solid #16003B;
       }

       .search-bar {
           position: relative;
           display: inline-block;
           align-items: center;
           margin-left: auto;
           margin-right: 20px;
       }

       .search-bar input {
           padding: 8px;
           padding-right: 40px;
           border: 2px solid #F72798;
           border-radius: 4px;
           font-size: 16px;
           width: 400px;
       }

       .search-button {
           position: absolute;
           right: 2px;
           top: 50%;
           transform: translateY(-50%);
           background: none;
           border: none;
           cursor: pointer;
           padding: 8px;
       }

       .search-button i {
           color: #F72798;
           font-size: 18px;
       }

       .btn {
           background-color: #F72798;
           color: #FFFFFF;
           padding: 8px 15px;
           border: none;
           border-radius: 4px;
           font-size: 17px;
           cursor: pointer;
           text-decoration: none;
           transition: all 0.3s ease;
           margin-left: 10px;
       }

       .btn:hover {
           background-color: #16003B;
           color: #F72798;
       }

       .content {
           margin-top: 230px;
           padding: 20px;
       }

       .company-buttons {
           display: flex;
           flex-wrap: wrap;
           gap: 10px;
           justify-content: center;
           margin: 20px 0;
       }

       .company-btn {
           padding: 8px 16px;
           border: 2px solid #F72798;
           background: #fff;
           color: #F72798;
           border-radius: 4px;
           cursor: pointer;
           transition: all 0.3s ease;
       }

       .company-btn.active {
           background: #F72798;
           color: #fff;
       }

       .schedule-title {
           text-align: center;
           font-size: 24px;
           font-weight: bold;
           margin-bottom: 20px;
       }

       .broadcast-table {
           width: 100%;
           overflow-x: auto;
       }

       .broadcast-row {
           display: flex;
           align-items: flex-start;
           margin-bottom: 20px;
           border: 1px solid #ddd;
           border-radius: 4px;
           background: white;
       }

       .company-column {
           min-width: 120px;
           padding: 10px;
           background: #f8f9fa;
           border-right: 1px solid #ddd;
           font-weight: bold;
       }

       .schedule-container {
           display: flex;
           overflow-x: auto;
           padding: 10px;
           align-items: flex-start;
       }

       .time-slot {
           min-width: 200px;
           margin-right: 15px;
           padding: 10px;
           background: white;
           border: 1px solid #eee;
           border-radius: 4px;
       }

       .broadcast-time {
           font-weight: bold;
           color: #666;
           margin-bottom: 5px;
       }

       .product-title {
           font-size: 14px;
           margin: 5px 0;
           color: #333;
           text-decoration: none;
       }

       .favorite-btn {
           background: none;
           border: none;
           color: #ccc;
           cursor: pointer;
           font-size: 16px;
           padding: 5px;
           transition: color 0.3s ease;
       }

       .favorite-btn:hover {
           color: #F72798;
       }

       .favorite-btn.active {
           color: #F72798;
       }

       .date-navigation {
           display: flex;
           justify-content: center;
           gap: 10px;
           margin-bottom: 20px;
       }

       .date-btn {
           padding: 8px 16px;
           border: 1px solid #ddd;
           background: white;
           border-radius: 4px;
           cursor: pointer;
       }

       .date-btn.active {
           background: #F72798;
           color: white;
       }
   </style>
</head>
<body>
   <a href="/" class="logo">
       <img src="/static/img/003.png" alt="Logo">
   </a>
   <a href="/" class="logo2">
       <img src="/static/img/006.png" alt="Banner">
   </a>

   <header class="header">
       <div class="container">
           <nav class="menu-bar">
               <a href="/trend">트렌드</a>
               <a href="/schedule">편성표</a>
               <a href="/favorites">즐겨찾기</a>
           </nav>

           <div class="search-bar">
               <form action="/search" method="get">
                   <input type="text" name="keyword" placeholder="상품명을 입력하세요" required>
                   <button type="submit" class="search-button">
                       <i class="fas fa-search"></i>
                   </button>
               </form>
           </div>

           <div class="user-actions">
               {% if logged_in_user %}
                   <a href="/myinfo" class="btn">마이페이지</a>
                   <a href="/logout" class="btn">로그아웃</a>
               {% else %}
                   <a href="/login" class="btn">Login</a>
               {% endif %}
           </div>
       </div>
   </header>

   <div class="content">
       <!-- 방송사 선택 버튼 -->
       <div class="company-buttons">
           {% for company in sorted_company_dates %}
               <button class="company-btn" onclick="toggleCompany('{{ company }}')">{{ company }}</button>
           {% endfor %}
       </div>

       <!-- 날짜 네비게이션 -->
       <div class="date-navigation">
           <button class="btn" onclick="prevDate()">이전</button>
           <div id="dateButtonsContainer" class="date-buttons-container">
               {% for date in all_dates %}
                   <button class="date-btn" onclick="selectDate('{{ date }}')">{{ date }}</button>
               {% endfor %}
           </div>
           <button class="btn" onclick="nextDate()">다음</button>
       </div>

       <h1 class="schedule-title">방송 편성표</h1>

       <!-- 방송 편성표 -->
       <div class="broadcast-table">
           {% for company in sorted_company_dates %}
               <div class="broadcast-row" data-company="{{ company }}">
                   <div class="company-column">{{ company }}</div>
                   <div class="schedule-container">
                       {% for date in all_dates %}
                           {% set items = broadcast_data[company][date] %}
                           {% for item in items %}
                                <div class="time-slot" data-date="{{ date }}">
                                   <div class="broadcast-time">{{ item.broadcast_time }}</div>
                                   {% if item.url %}
                                       <a href="{{ item.url }}" class="product-title" target="_blank" 
                                          onclick="logProductClick('{{ item.broadcast_time }}', '{{ item.title }}', '{{ item.url }}', '{{ item.image_url }}', '{{ item.price }}')">
                                           {{ item.title }}
                                       </a>
                                   {% else %}
                                       <div class="product-title">{{ item.title }}</div>
                                   {% endif %}
                                   {% if logged_in_user %}
                                       <button class="favorite-btn" 
                                               onclick="toggleFavorite('{{ item.broadcast_time }}', '{{ item.title }}', '{{ item.url }}', '{{ item.image_url }}', '{{ item.price }}')">
                                           <i class="fas fa-heart"></i>
                                       </button>
                                   {% endif %}
                               </div>
                           {% endfor %}
                       {% endfor %}
                   </div>
               </div>
           {% endfor %}
       </div>
   </div>

   <script>
       let selectedCompanies = [];
       let currentDate = '';

       function toggleCompany(company) {
           const index = selectedCompanies.indexOf(company);
           const button = document.querySelector(`.company-btn[onclick="toggleCompany('${company}')"]`);
           
           if (index === -1) {
               selectedCompanies.push(company);
               button.classList.add('active');
           } else {
               selectedCompanies.splice(index, 1);
               button.classList.remove('active');
           }
           
           filterCompanies();
       }

       function filterCompanies() {
           const rows = document.querySelectorAll('.broadcast-row');
           rows.forEach(row => {
               const company = row.getAttribute('data-company');
               if (selectedCompanies.length === 0 || selectedCompanies.includes(company)) {
                   row.style.display = '';
               } else {
                   row.style.display = 'none';
               }
           });
       }

       function selectDate(date) {
        console.log("Selected date:", date);
        
        // 날짜 버튼 활성화
        document.querySelectorAll('.date-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.textContent === date) {
                btn.classList.add('active');
            }
        });
    
        // 날짜 셀 필터링
        document.querySelectorAll('.date-cell').forEach(cell => {
            console.log("Checking cell:", cell.className);
            if(cell.classList.contains(`date-cell-${date}`)) {
                cell.style.display = '';
            } else {
                cell.style.display = 'none';
            }
        });

         // 시간 슬롯 필터링 
        document.querySelectorAll('.time-slot').forEach(slot => {
            const slotDate = slot.getAttribute('data-date');
            if(slotDate === date) {
                slot.style.display = '';
            } else {
                slot.style.display = 'none';
            }
        });
    }
    
    

       function toggleFavorite(broadcast_time, title, url, image_url, price) {
           const button = event.currentTarget;
           const icon = button.querySelector('i');
           
           fetch('/toggle_favorite', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                   broadcast_time,
                   title,
                   url,
                   image_url,
                   price
               })
           })
           .then(response => response.json())
           .then(data => {
               if (data.message === "즐겨찾기 추가") {
                   icon.style.color = "#F72798";
               } else {
                   icon.style.color = "#ccc";
               }
           });
       }

       function logProductClick(broadcast_time, title, url, image_url, price) {
           fetch('/log_product_click', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                   broadcast_time,
                   title,
                   url,
                   image_url,
                   price,
                   timestamp: new Date().toISOString()
               })
           });
       }

       // 초기화
       document.addEventListener('DOMContentLoaded', function() {
           if (all_dates.length > 0) {
               selectDate(all_dates[0]);
           }
       });
   </script>

   <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>